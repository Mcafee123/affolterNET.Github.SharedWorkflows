name: Deploy and Tag

on:
  workflow_call:
    inputs:

      # Configuration
      build-file:
        description: "Path to build configuration JSON file"
        required: true
        type: string
      deploy-file:
        description: "Path to deployment configuration JSON file"
        required: true
        type: string

      # Deploy options
      tag: 
        description: "Tag to deploy (if not provided, will read version and generate tag)"
        required: false
        type: string
        default: ""
      run-security-scan:
        description: "Whether to run security scan after deployment"
        required: false
        type: boolean
        default: false

    secrets:

      # Github
      ssh-private-key:
        required: true

      # Azure
      azure-credentials:
        required: true
      arm-client-id:
        required: true
      arm-client-secret:
        required: true
      arm-tenant-id:
        required: true
      arm-subscription-id:
        required: true

      # ACR
      acr-username:
        required: true
      acr-password:
        required: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.determine.outputs.version }}
      tag: ${{ steps.determine.outputs.tag }}
    steps:
    - name: Checkout code (only if no tag provided)
      if: inputs.tag == ''
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/checkout@main

    - name: Load configuration (only if no tag provided)
      if: inputs.tag == ''
      id: config
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/load-config@main
      with:
        build-file: ${{ inputs.build-file }}
        deploy-file: ${{ inputs.deploy-file }}

    - name: Read version from action (only if no tag provided)
      if: inputs.tag == ''
      id: get-version
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/version@main
      with:
        project_file: ${{ steps.config.outputs.backend-root }}/${{ steps.config.outputs.backend-folder }}/${{ steps.config.outputs.backend-project-file}}
        action: read
        scripts-version: ${{ steps.config.outputs.scripts-version }}

    - name: Determine final version and tag
      id: determine
      run: |
        if [ -n "${{ inputs.tag }}" ]; then
          # Tag provided - extract version from it
          TAG="${{ inputs.tag }}"
          if [[ "$TAG" == *-* ]]; then
            VERSION="${TAG##*-}"
          else
            VERSION="$TAG"
          fi
          echo "Using input tag: $TAG"
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
        else
          # No tag provided - use version from action and generate tag
          VERSION="${{ steps.get-version.outputs.version }}"
          TAG="${{ steps.config.outputs.tag-prefix }}-$VERSION"
          echo "Using version from action: $VERSION"
          echo "Generated tag: $TAG"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
        fi

    - name: Summary
      run: |
        echo "ðŸ”¢ Version and Tag Determination Summary"
        echo "  Inputs:"
        echo "    - input-tag: ${{ inputs.tag != '' && inputs.tag || '(not provided - will read from action)' }}"
        echo "  Final results:"
        echo "    - version: ${{ steps.determine.outputs.version }}"
        echo "    - tag: ${{ steps.determine.outputs.tag }}"
  
  deploy:
    name: 'deploy: ${{ needs.prepare.outputs.tag }}'
    runs-on: ubuntu-latest
    needs: prepare
    steps:

    - name: Checkout code
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/checkout@main
      with:
        ref: ${{ needs.prepare.outputs.tag }}

    # Load configuration
    - name: Load configuration
      id: config
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/load-config@main
      with:
        build-file: ${{ inputs.build-file }}
        deploy-file: ${{ inputs.deploy-file }}

    - name: Deploy Workflow Started
      shell: bash
      run: |
        echo "ðŸš€ Starting Deploy and Tag Workflow"
        echo "All inputs received:"
        echo "  Docker inputs:"
        echo "    - image-name: ${{ steps.config.outputs.image-name }}"
        echo "    - registry-name: ${{ steps.config.outputs.registry-name }}"
        echo "  Version inputs:"
        echo "    - version: ${{ needs.prepare.outputs.version }}"
        echo "    - tag: ${{ needs.prepare.outputs.tag }}"
        echo "  Tag inputs:"
        echo "    - tag-prefix: ${{ steps.config.outputs.tag-prefix }}"
        echo "  Terraform inputs:"
        echo "    - tf-module-path: ${{ steps.config.outputs.tf-module-path }}"
        echo "  Secrets provided:"
        echo "    - ssh-private-key: $([ -n '${{ secrets.ssh-private-key }}' ] && echo 'Yes' || echo 'No')"
        echo "    - azure-credentials: $([ -n '${{ secrets.azure-credentials }}' ] && echo 'Yes' || echo 'No')"
        echo "    - arm-client-id: $([ -n '${{ secrets.arm-client-id }}' ] && echo 'Yes' || echo 'No')"
        echo "    - arm-client-secret: $([ -n '${{ secrets.arm-client-secret }}' ] && echo 'Yes' || echo 'No')"
        echo "    - arm-tenant-id: $([ -n '${{ secrets.arm-tenant-id }}' ] && echo 'Yes' || echo 'No')"
        echo "    - arm-subscription-id: $([ -n '${{ secrets.arm-subscription-id }}' ] && echo 'Yes' || echo 'No')"
        echo "    - acr-username: $([ -n '${{ secrets.acr-username }}' ] && echo 'Yes' || echo 'No')"
        echo "    - acr-password: $([ -n '${{ secrets.acr-password }}' ] && echo 'Yes' || echo 'No')"

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: '1.7.5'
        terraform_wrapper: false  # Needed to properly capture outputs

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.azure-credentials }}

    - name: Setup SSH key for private repositories
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.ssh-private-key }}

    - name: Terraform Init
      run: terraform init -backend-config=_backend.hcl
      working-directory: ${{ steps.config.outputs.tf-module-path }}
      env:
        ARM_CLIENT_ID: ${{ secrets.arm-client-id }}
        ARM_CLIENT_SECRET: ${{ secrets.arm-client-secret }}
        ARM_TENANT_ID: ${{ secrets.arm-tenant-id }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.arm-subscription-id }}
        ARM_USE_CLI: false

    - name: Terraform Plan
      id: plan
      run: |
        terraform plan -out=tfplan
        echo "plan_status=success" >> $GITHUB_OUTPUT
      working-directory: ${{ steps.config.outputs.tf-module-path }}
      env:
        ARM_CLIENT_ID: ${{ secrets.arm-client-id }}
        ARM_CLIENT_SECRET: ${{ secrets.arm-client-secret }}
        ARM_TENANT_ID: ${{ secrets.arm-tenant-id }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.arm-subscription-id }}
        ARM_USE_CLI: false

    - name: Terraform Apply
      id: apply
      run: |
        terraform apply -auto-approve tfplan
        echo "apply_status=success" >> $GITHUB_OUTPUT
      working-directory: ${{ steps.config.outputs.tf-module-path }}
      env:
        ARM_CLIENT_ID: ${{ secrets.arm-client-id }}
        ARM_CLIENT_SECRET: ${{ secrets.arm-client-secret }}
        ARM_TENANT_ID: ${{ secrets.arm-tenant-id }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.arm-subscription-id }}
        ARM_USE_CLI: false

    - name: Cleanup Terraform plan
      if: always()
      run: rm -f tfplan
      working-directory: ${{ steps.config.outputs.tf-module-path }}

    - name: Create deployment summary
      run: |
        VERSION="${{ needs.prepare.outputs.version }}"
        TAG="${{ needs.prepare.outputs.tag }}"
        echo "## ðŸš€ App Deployment Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Development" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** ${{ steps.config.outputs.registry-name }}/${{ steps.config.outputs.image-name }}:$VERSION" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Deployment Information:" >> $GITHUB_STEP_SUMMARY
        echo "- **Terraform Directory:** tf/dev/app" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY

        # Job 4: Security scan (optional but recommended)
  
  security-scan:
    if: ${{ inputs.run-security-scan }}
    runs-on: ubuntu-latest
    needs: prepare
    
    steps:

    - name: Checkout code
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/checkout@main
      with:
        ref: ${{ needs.prepare.outputs.tag }}

    # Load configuration
    - name: Load configuration
      id: config
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/load-config@main
      with:
        build-file: ${{ inputs.build-file }}
        deploy-file: ${{ inputs.deploy-file }}

    - name: Debug ACR credentials
      run: |
        echo "Registry: ${{ steps.config.outputs.registry-name }}"
        echo "Username length: ${#ACR_USERNAME}"
        echo "Password length: ${#ACR_PASSWORD}"
        if [ -z "$ACR_USERNAME" ] || [ -z "$ACR_PASSWORD" ]; then
          echo "ERROR: ACR credentials are empty!"
          echo "Username empty: $([ -z "$ACR_USERNAME" ] && echo 'YES' || echo 'NO')"
          echo "Password empty: $([ -z "$ACR_PASSWORD" ] && echo 'YES' || echo 'NO')"
        else
          echo "ACR credentials are available"
        fi
      env:
        ACR_USERNAME: ${{ secrets.acr-username }}
        ACR_PASSWORD: ${{ secrets.acr-password }}
        
    - name: Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ steps.config.outputs.registry-name }}
        username: ${{ secrets.acr-username }}
        password: ${{ secrets.acr-password }}

    - name: Run Trivy vulnerability scanner (SARIF)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ steps.config.outputs.registry-name }}/${{ steps.config.outputs.image-name }}:${{ needs.prepare.outputs.version }}'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Run Trivy vulnerability scanner (Table format)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ steps.config.outputs.registry-name }}/${{ steps.config.outputs.image-name }}:${{ needs.prepare.outputs.version }}'
        format: 'table'
        output: 'trivy-results.txt'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      continue-on-error: true
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Upload Trivy scan results as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: trivy-scan-results-${{ steps.config.outputs.tag-prefix }}-${{ needs.prepare.outputs.version }}
        path: |
          trivy-results.sarif
          trivy-results.txt

    - name: Display security scan summary
      if: always()
      run: |
        echo "## ðŸ” Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Scanned:** \`${{ steps.config.outputs.registry-name }}/${{ steps.config.outputs.image-name }}:${{ needs.prepare.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f trivy-results.txt ]; then
          echo "### Vulnerability Summary:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -50 trivy-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Full results available in workflow artifacts**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Security scan results not available" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **Note:** To view detailed security findings in GitHub Security tab, enable Code Scanning in repository settings." >> $GITHUB_STEP_SUMMARY

