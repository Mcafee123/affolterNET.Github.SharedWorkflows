name: Deploy and Tag

on:
  workflow_call:
    inputs:

      # Configuration
      build-file:
        description: "Path to build configuration JSON file"
        required: true
        type: string
      deploy-file:
        description: "Path to deployment configuration JSON file"
        required: true
        type: string

      # Deploy options
      version: 
        description: "Version to deploy"
        required: false
        type: string
        default: ""
      run-security-scan:
        description: "Whether to run security scan after deployment"
        required: false
        type: boolean
        default: false

    secrets:

      # Github
      github-token:
        required: true
      ssh-private-key:
        required: true

      # Azure
      azure-credentials:
        required: true
      arm-client-id:
        required: true
      arm-client-secret:
        required: true
      arm-tenant-id:
        required: true
      arm-subscription-id:
        required: true

      # ACR
      acr-username:
        required: true
      acr-password:
        required: true

jobs:
  versioning:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
      tag: ${{ steps.set-version.outputs.tag }}
    steps:
    - name: Checkout code
      if: inputs.version == ''
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/checkout@main

    # Load configuration (always needed for tag-prefix)
    - name: Load configuration
      id: config
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/load-config@main
      with:
        build-file: ${{ inputs.build-file }}
        deploy-file: ${{ inputs.deploy-file }}

    - name: Read Version from Action
      if: inputs.version == ''
      id: get-version
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/version@main
      with:
        project_file: ${{ steps.config.outputs.backend-root }}/${{ steps.config.outputs.backend-folder }}/${{ steps.config.outputs.backend-project-file}}
        tfvars_file: ${{ steps.config.outputs.tf-module-path }}/${{ steps.config.outputs.tfvars-file }}
        action: read
        version-script: ${{ steps.config.outputs.version-script }}

    - name: Set Final Version and Tag
      id: set-version
      run: |
        if [ -n "${{ inputs.version }}" ]; then
          echo "Using input version: ${{ inputs.version }}"
          echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "Using version from action: ${{ steps.get-version.outputs.version }}"
          echo "version=${{ steps.get-version.outputs.version }}" >> $GITHUB_OUTPUT
        fi
        
        # Set tag using the determined version
        VERSION="${{ inputs.version != '' && inputs.version || steps.get-version.outputs.version }}"
        TAG="${{ steps.config.outputs.tag-prefix }}-$VERSION"
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Final tag: $TAG"

    - name: Versioning Workflow Summary
      shell: bash
      run: |
        echo "ðŸ”¢ Versioning Workflow Summary"
        echo "All inputs received:"
        echo "  Configuration inputs:"
        echo "    - build-file: ${{ inputs.build-file }}"
        echo "    - deploy-file: ${{ inputs.deploy-file }}"
        echo "  Version inputs:"
        echo "    - input-version: ${{ inputs.version != '' && inputs.version || '(not provided - reading from action)' }}"
        echo "    - run-security-scan: ${{ inputs.run-security-scan }}"
        echo "  Determined values:"
        echo "    - final-version: ${{ steps.set-version.outputs.version }}"
        echo "    - final-tag: ${{ steps.set-version.outputs.tag }}"
        echo "  Configuration outputs:"
        echo "    - tag-prefix: ${{ steps.config.outputs.tag-prefix }}"
        echo "    - backend-project: ${{ steps.config.outputs.backend-root }}/${{ steps.config.outputs.backend-folder }}/${{ steps.config.outputs.backend-project-file }}"
    
  deploy-and-tag:
    name: 'deploy: ${{ needs.versioning.outputs.tag }}'
    runs-on: ubuntu-latest
    needs: versioning
    steps:

    - name: Checkout code
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/checkout@main
      with:
        ref: ${{ needs.versioning.outputs.tag }}

    # Load configuration
    - name: Load configuration
      id: config
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/load-config@main
      with:
        build-file: ${{ inputs.build-file }}
        deploy-file: ${{ inputs.deploy-file }}

    - name: Deploy Workflow Started
      shell: bash
      run: |
        echo "ðŸš€ Starting Deploy and Tag Workflow"
        echo "All inputs received:"
        echo "  Docker inputs:"
        echo "    - image-name: ${{ steps.config.outputs.image-name }}"
        echo "    - registry-name: ${{ steps.config.outputs.registry-name }}"
        echo "  Version inputs:"
        echo "    - version: ${{ needs.versioning.outputs.version }}"
        echo "    - tag: ${{ needs.versioning.outputs.tag }}"
        echo "  Tag inputs:"
        echo "    - tag-prefix: ${{ steps.config.outputs.tag-prefix }}"
        echo "    - tag-script: ${{ steps.config.outputs.tag-script }}"
        echo "  Terraform inputs:"
        echo "    - tf-module-path: ${{ steps.config.outputs.tf-module-path }}"
        echo "  Versioning inputs:"
        echo "    - scripts-version: ${{ steps.config.outputs.scripts-version }}"
        echo "  Secrets provided:"
        echo "    - github-token: $([ -n '${{ secrets.github-token }}' ] && echo 'Yes' || echo 'No')"
        echo "    - ssh-private-key: $([ -n '${{ secrets.ssh-private-key }}' ] && echo 'Yes' || echo 'No')"
        echo "    - azure-credentials: $([ -n '${{ secrets.azure-credentials }}' ] && echo 'Yes' || echo 'No')"
        echo "    - arm-client-id: $([ -n '${{ secrets.arm-client-id }}' ] && echo 'Yes' || echo 'No')"
        echo "    - arm-client-secret: $([ -n '${{ secrets.arm-client-secret }}' ] && echo 'Yes' || echo 'No')"
        echo "    - arm-tenant-id: $([ -n '${{ secrets.arm-tenant-id }}' ] && echo 'Yes' || echo 'No')"
        echo "    - arm-subscription-id: $([ -n '${{ secrets.arm-subscription-id }}' ] && echo 'Yes' || echo 'No')"
        echo "    - acr-username: $([ -n '${{ secrets.acr-username }}' ] && echo 'Yes' || echo 'No')"
        echo "    - acr-password: $([ -n '${{ secrets.acr-password }}' ] && echo 'Yes' || echo 'No')"

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: '1.7.5'
        terraform_wrapper: false  # Needed to properly capture outputs

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.azure-credentials }}

    - name: Setup SSH key for private repositories
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.ssh-private-key }}

    - name: Terraform Init
      run: terraform init -backend-config=_backend.hcl
      working-directory: ${{ steps.config.outputs.tf-module-path }}
      env:
        ARM_CLIENT_ID: ${{ secrets.arm-client-id }}
        ARM_CLIENT_SECRET: ${{ secrets.arm-client-secret }}
        ARM_TENANT_ID: ${{ secrets.arm-tenant-id }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.arm-subscription-id }}
        ARM_USE_CLI: false

    - name: Terraform Plan
      id: plan
      run: |
        terraform plan -out=tfplan
        echo "plan_status=success" >> $GITHUB_OUTPUT
      working-directory: ${{ steps.config.outputs.tf-module-path }}
      continue-on-error: true
      env:
        ARM_CLIENT_ID: ${{ secrets.arm-client-id }}
        ARM_CLIENT_SECRET: ${{ secrets.arm-client-secret }}
        ARM_TENANT_ID: ${{ secrets.arm-tenant-id }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.arm-subscription-id }}
        ARM_USE_CLI: false

    - name: Terraform Apply
      id: apply
      if: steps.plan.outputs.plan_status == 'success'
      run: |
        terraform apply -auto-approve tfplan
        echo "apply_status=success" >> $GITHUB_OUTPUT
      working-directory: ${{ steps.config.outputs.tf-module-path }}
      env:
        ARM_CLIENT_ID: ${{ secrets.arm-client-id }}
        ARM_CLIENT_SECRET: ${{ secrets.arm-client-secret }}
        ARM_TENANT_ID: ${{ secrets.arm-tenant-id }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.arm-subscription-id }}
        ARM_USE_CLI: false

    - name: Cleanup Terraform plan
      if: always()
      run: rm -f tfplan
      working-directory: ${{ steps.config.outputs.tf-module-path }}

    - name: Create deployment summary
      if: steps.apply.outputs.apply_status == 'success'
      run: |
        VERSION="${{ needs.versioning.outputs.version }}"
        TAG="${{ needs.versioning.outputs.tag }}"
        echo "## ðŸš€ App Deployment Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Development" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** ${{ steps.config.outputs.registry-name }}/${{ steps.config.outputs.image-name }}:$VERSION" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Deployment Information:" >> $GITHUB_STEP_SUMMARY
        echo "- **Terraform Directory:** tf/dev/app" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY

        # Job 4: Security scan (optional but recommended)
  
  security-scan:
    if: ${{ inputs.run-security-scan }}
    runs-on: ubuntu-latest
    needs: versioning
    
    steps:

    - name: Checkout code
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/checkout@main
      with:
        ref: ${{ needs.versioning.outputs.tag }}

    # Load configuration
    - name: Load configuration
      id: config
      uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/load-config@main
      with:
        build-file: ${{ inputs.build-file }}
        deploy-file: ${{ inputs.deploy-file }}

    - name: Debug ACR credentials
      run: |
        echo "Registry: ${{ steps.config.outputs.registry-name }}"
        echo "Username length: ${#ACR_USERNAME}"
        echo "Password length: ${#ACR_PASSWORD}"
        if [ -z "$ACR_USERNAME" ] || [ -z "$ACR_PASSWORD" ]; then
          echo "ERROR: ACR credentials are empty!"
          echo "Username empty: $([ -z "$ACR_USERNAME" ] && echo 'YES' || echo 'NO')"
          echo "Password empty: $([ -z "$ACR_PASSWORD" ] && echo 'YES' || echo 'NO')"
        else
          echo "ACR credentials are available"
        fi
      env:
        ACR_USERNAME: ${{ secrets.acr-username }}
        ACR_PASSWORD: ${{ secrets.acr-password }}
        
    - name: Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ steps.config.outputs.registry-name }}
        username: ${{ secrets.acr-username }}
        password: ${{ secrets.acr-password }}

    - name: Run Trivy vulnerability scanner (SARIF)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ steps.config.outputs.registry-name }}/${{ steps.config.outputs.image-name }}:${{ needs.versioning.outputs.version }}'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Run Trivy vulnerability scanner (Table format)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ steps.config.outputs.registry-name }}/${{ steps.config.outputs.image-name }}:${{ needs.versioning.outputs.version }}'
        format: 'table'
        output: 'trivy-results.txt'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      continue-on-error: true
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Upload Trivy scan results as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: trivy-scan-results-${{ needs.versioning.outputs.version }}
        path: |
          trivy-results.sarif
          trivy-results.txt

    - name: Display security scan summary
      if: always()
      run: |
        echo "## ðŸ” Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Scanned:** \`${{ steps.config.outputs.registry-name }}/${{ steps.config.outputs.image-name }}:${{ needs.versioning.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f trivy-results.txt ]; then
          echo "### Vulnerability Summary:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -50 trivy-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Full results available in workflow artifacts**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Security scan results not available" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **Note:** To view detailed security findings in GitHub Security tab, enable Code Scanning in repository settings." >> $GITHUB_STEP_SUMMARY

