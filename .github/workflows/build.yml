name: Build

on:
  workflow_call:
    inputs:

      # Configuration
      build-file:
        description: "Path to build configuration JSON file"
        required: true
        type: string
      deploy-file:
        description: "Path to deployment configuration JSON file"
        required: true
        type: string

      # Override options (optional)
      push:
        description: "Push Docker image"
        required: false
        type: boolean
      update-version:
        description: "Update version"
        required: false
        type: boolean

    secrets:

      # ACR
      acr-username:
        description: 'Azure Container Registry username'
        required: false
      acr-password:
        description: 'Azure Container Registry password'
        required: false

    outputs:
      version:
        description: 'The version read from or written to the backend project file'
        value: ${{ jobs.build.outputs.version }}
      tag:
        description: 'The tag created for the build'
        value: ${{ jobs.build.outputs.tag }}

jobs:
  build:
    runs-on: ubuntu-latest
    name: 'build: ${{ github.head_ref || github.ref_name }}'
    outputs:
      version: ${{ steps.version.outputs.version }}  # Job captures step output
      tag: '${{ steps.config.outputs.tag-prefix }}-${{ steps.version.outputs.version }}'
    steps:

      - name: Checkout code
        uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/checkout@main
        with:
          fetch-depth: 0

      # Load configuration at the start of the job
      - name: Load configuration
        id: config
        uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/load-config@main
        with:
          build-file: ${{ inputs.build-file }}
          deploy-file: ${{ inputs.deploy-file }}

      # Skip if PR is running to main
      - name: Check if should skip
        run: |
          echo "‚ö†Ô∏è Skipping build - PR is running to main"

      - name: Build Workflow Started
        shell: bash
        run: |
          echo "üöÄ Starting Build Workflow"
          echo "All inputs received:"
          echo "  Frontend inputs:"
          echo "    - build-frontend: ${{ steps.config.outputs.build-frontend }}"
          echo "    - frontend-root: ${{ steps.config.outputs.frontend-root }}"
          echo "    - frontend-build-command: ${{ steps.config.outputs.frontend-build-command }}"
          echo "    - node-version: ${{ steps.config.outputs.node-version }}"
          echo "  Backend inputs:"
          echo "    - backend-root: ${{ steps.config.outputs.backend-root }}"
          echo "    - backend-folder: ${{ steps.config.outputs.backend-folder }}"
          echo "    - backend-project-file: ${{ steps.config.outputs.backend-project-file }}"
          echo "  Docker inputs:"
          echo "    - image-name: ${{ steps.config.outputs.image-name }}"
          echo "    - registry-name: ${{ steps.config.outputs.registry-name }}"
          echo "    - dockerfile: ${{ steps.config.outputs.dockerfile }}"
          echo "    - push: ${{ inputs.push }}"
          echo "  Versioning inputs:"
          echo "    - update-version: ${{ inputs.update-version }}"
          echo "    - version-script: ${{ steps.config.outputs.version-script }}"
          echo "    - scripts-version: ${{ steps.config.outputs.scripts-version }}"
          echo "  Terraform inputs:"
          echo "    - tf-module-path: ${{ steps.config.outputs.tf-module-path }}"
          echo "    - tfvars-file: ${{ steps.config.outputs.tfvars-file }}"
          echo "  Secrets provided:"
          echo "    - acr-username: $([ -n '${{ secrets.acr-username }}' ] && echo 'Yes' || echo 'No')"
          echo "    - acr-password: $([ -n '${{ secrets.acr-password }}' ] && echo 'Yes' || echo 'No')"

      - name: Get version scripts
        uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/get-scripts@main
        with:
          scripts-version: ${{ steps.config.outputs.scripts-version }}
          github-token: ${{ github.token }}

      - name: Version
        id: version
        uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/version@main
        with:
          project_file: ${{ steps.config.outputs.backend-root }}/${{ steps.config.outputs.backend-folder }}/${{ steps.config.outputs.backend-project-file}}
          tfvars_file: ${{ steps.config.outputs.tf-module-path }}/${{ steps.config.outputs.tfvars-file }}
          action: ${{ inputs.update-version == true && 'update' || 'read' }}
          version-script: ${{ steps.config.outputs.version-script }}

      - name: Build Frontend
        if: steps.config.outputs.build-frontend == 'true'
        uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/build-frontend@main
        with:
          frontend-root: ${{ steps.config.outputs.frontend-root }}
          build-command: ${{ steps.config.outputs.frontend-build-command }}
          node-version: ${{ steps.config.outputs.node-version }}

      - name: Build Backend
        uses: Mcafee123/affolterNET.Github.SharedWorkflows/actions/build-backend@main
        with:
          version: ${{ steps.version.outputs.version }}
          project-root: ${{ steps.config.outputs.backend-root }}
          project-folder: ${{ steps.config.outputs.backend-folder }}
          project-file: ${{ steps.config.outputs.backend-project-file }}
          dockerfile: ${{ steps.config.outputs.dockerfile }}
          image-name: ${{ steps.config.outputs.image-name }}
          registry-name: ${{ steps.config.outputs.registry-name }}
          push: ${{ inputs.push }}
          version-script: ${{ steps.config.outputs.version-script }}
          scripts-version: ${{ steps.config.outputs.scripts-version }}
          acr-username: ${{ secrets.acr-username }}
          acr-password: ${{ secrets.acr-password }}

      - name: Create Git tag
        if: inputs.push
        env:
          GITHUB_TOKEN: ${{ secrets.github-token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Creating git tag using: ./${{ steps.config.outputs.tag-script }} ${{ steps.version.outputs.version }} ${{ steps.config.outputs.tag-prefix }} ${{ steps.config.outputs.registry-name }} ${{ steps.config.outputs.image-name }}"
          ./${{ steps.config.outputs.tag-script }} ${{ steps.version.outputs.version }} ${{ steps.config.outputs.tag-prefix }} ${{ steps.config.outputs.registry-name }} ${{ steps.config.outputs.image-name }}
